import{a as E,b as _,e as b,f as A,g as L,i as h,j as W}from"https://st-p.rmcdn.net/aab27dd3/dist/c/c-5FZORQMA.js";import{g as y,h as l,k as O}from"https://st-p.rmcdn.net/aab27dd3/dist/c/c-J3USEBGX.js";import{a as C,p as N}from"https://st-p.rmcdn.net/aab27dd3/dist/c/c-S3E6VOTB.js";import{c as v,d as k}from"https://st-p.rmcdn.net/aab27dd3/dist/c/c-RED2IW26.js";import{a as S,b as T}from"https://st-p.rmcdn.net/aab27dd3/dist/c/c-RAPBUJGJ.js";import{b as u,c as I}from"https://st-p.rmcdn.net/aab27dd3/dist/c/c-XISRCAED.js";import{b as D}from"https://st-p.rmcdn.net/aab27dd3/dist/c/c-B7IF4UMF.js";import{a as m,f as s}from"https://st-p.rmcdn.net/aab27dd3/dist/c/c-QHP3NFJY.js";var d,w=m(()=>{"use strict";E();I();L();d=class{constructor(t){s(this,"numId");s(this,"libraryAdded",!1);s(this,"stripeAccount","");this.numId=t}async disconnect(t){return await b(t,"stripe")}async loadProducts(t,e){return(await A(t,!!e)).data||[]}mapProductsToSelectOptions(t,e){let r=t.filter(i=>i.active&&(i.articles?.length||i.prices?.length)||e&&e===i.id).map(i=>({value:i.id,caption:i.name}));return r.unshift({value:"default",caption:"None"}),r}isProductActive(t){return t.active&&(this.productHasActiveOptions(t)||this.productHasActivePrice(t))}productHasActiveOptions(t){return Array.isArray(t.articles)&&!!t.articles?.some(e=>e.active)}productHasActivePrice(t){return Array.isArray(t.prices)&&!!t.prices?.some(e=>e.active)}isProductAvailable(t,e){if(t.prices?.length)return this.productHasActivePrice(t);if(t.articles?.length)if(e){let r=t.articles?.find(i=>i.id===e);return r?this.isSkuAvailable(r):!1}else return!!t.articles?.some(r=>this.isSkuAvailable(r));return!1}isSkuAvailable(t){return t.active?t.inventory.type==="infinite"||!!(t.inventory.type==="finite"&&t.inventory.quantity)||t.inventory.type==="bucket"&&(t.inventory.value==="in_stock"||t.inventory.value==="limited"):!1}getProductForAddToCart(t,e){if(!t)return null;let r=this.getActivePrice(t);if(r){let o={...t,articles:null,prices:null};return{...r,productObject:o}}let i=e?this.getSkuBySelectsValues(t,e):null;if(i){let o={...t,articles:null,prices:null};return{...i,productObject:o}}return null}getActivePrice(t){if(Array.isArray(t.prices)&&t.prices.length){let e;return t.default_price&&(e=t.prices.find(r=>r.active&&r.billing_scheme==="per_unit"&&r.id===t.default_price)),e||(e=t.prices.find(r=>r.active&&r.billing_scheme==="per_unit")),e}return null}getSkuBySelectsValues(t,e){return!t||!Array.isArray(t.articles)||t.articles.length===0?null:t.articles.length===1?t.articles[0]:t.articles.find(r=>JSON.stringify(r.attributes)===JSON.stringify(e))}initFrontendLibrary(t){if(!this.libraryAdded&&t?.stripe?.stripe_data.stripe_user_id){let e=document.createElement("script");e.setAttribute("async","async"),e.setAttribute("src","https://js.stripe.com/v3/"),document?.body?.appendChild(e),this.libraryAdded=!0,this.stripeAccount=t.stripe.stripe_data.stripe_user_id}}getFormattedProductToAddToCart(t,e){if(e&&Object.keys(e).length)return null;let r={...t},i=this.getActivePrice(r);return!i||!i.unit_amount?null:{id:i.id,name:r.name,image:r.images?.[0],price:Number((i.unit_amount/100).toFixed(2)),currency:i.currency,type:i.type}}createCheckoutSession(t,e){let r=[],i=!1;Object.keys(t).forEach(n=>{r.push({price:t[n].id,quantity:t[n].cartQuantity}),t[n].type==="recurring"&&(i=!0)});let o=window?.location.href.split("?")[0],a=i?"subscription":"payment",c={line_items:r,success_url:`${o}?checkout_status=success&mode=${a}&session_id={CHECKOUT_SESSION_ID}`,cancel_url:`${o}?checkout_status=cancel`,payment_method_types:["card"],mode:a,...e||{}};return i&&(c.shipping_options||c.shipping_address_collection)&&(delete c.shipping_options,delete c.shipping_address_collection),_(this.numId,c)}goToCheckout({items:t,options:e}){let r=u.stripe_live?u.STRIPE_LIVE_PUBLIC_KEY:u.STRIPE_TEST_PUBLIC_KEY,i=Stripe(r||"",{stripeAccount:this.stripeAccount});this.createCheckoutSession(t,e).then(({data:o})=>{i.redirectToCheckout({sessionId:o.id})}).catch(o=>{console.error("Error:",o)})}}});var x,B,g,M=m(()=>{"use strict";k();w();W();O();E();N();D();x=["stripe","ecwid"],B={out_of_stock:"Out of stock"},g=class{constructor({numId:t,ecommerceData:e,cartWidgetData:r,isDownloadedSource:i,isPublished:o,isScreenshoter:a,onDataChange:c}){s(this,"isDownloadedSource");s(this,"isPublished");s(this,"isScreenshoter");s(this,"userLocale","en");s(this,"numId",0);s(this,"ecommerceData");s(this,"cartWidgetData");s(this,"provider");s(this,"products",[]);s(this,"productsState","initial");s(this,"isCartWidgetExist",!1);s(this,"adapter");s(this,"onDataChange");this.numId=t,this.isDownloadedSource=i,this.isPublished=o,this.isScreenshoter=a,this.ecommerceData=e,r&&(this.cartWidgetData=r,this.isCartWidgetExist=!0),c&&typeof c=="function"&&(this.onDataChange=c);let n=window.navigator.language;if(n&&(this.userLocale=n.substring(0,2)),this.ecommerceData){let f=this.getConnectedProvider();if(f){this.provider=f,this.connectEcommerceAdapter(),this.loadProducts();let P=localStorage.getItem(l(this.numId));P&&P!==this.provider&&localStorage.removeItem(y(this.numId)),localStorage.setItem(l(this.numId),this.provider)}}}setOnDataChangeCallback(t){this.onDataChange||(this.onDataChange=t)}triggerDataChanges(t){this.onDataChange&&this.onDataChange(t)}setCartWidgetExistState(t){this.isCartWidgetExist=t}getConnectedProvider(){if(this.provider)return this.provider;if(!this.ecommerceData)return null;let t=this.getProviderFrom(this.ecommerceData);return this.provider=t,t}getProviderFrom(t){return x.find(r=>t[r]&&t[r].status==="connected")}canBeConnectedTo(t){let e=this.getConnectedProvider();return!(e&&t!==e)}async updateEcommerceDataFromServer(){let t=await C(this.numId);if(t?.ecommerce_data)return this.updateEcommerceData(t.ecommerce_data),t.ecommerce_data}async updateEcommerceData(t){this.ecommerceData=t;let e=this.getProviderFrom(t);this.provider!==e&&(this.provider=e,this.connectEcommerceAdapter(),this.triggerDataChanges({provider:e}),await this.loadProducts())}getTextValue(t){let e=this.ecommerceData?.texts?.[t];return e?v.sanitize(e):B[t]}setTextValue(t,e){this.ecommerceData?.texts&&(this.ecommerceData.texts[t]=e)}async disconnect(){if(!this.provider||!this.adapter)throw new Error("Ecommerce provider is not defined");let t=await this.adapter.disconnect(this.numId),e={...this.ecommerceData};return t&&this.ecommerceData&&(e={...e,[this.provider]:t},this.updateEcommerceData(e)),e}connectEcommerceAdapter(){switch(this.provider){case"stripe":this.adapter=new d(this.numId);break;case"ecwid":this.adapter=new h(this.numId);break;default:this.adapter=void 0}}async loadProducts(){if(!this.provider||!this.adapter){this.products=[],this.triggerDataChanges({products:[]});return}if(this.isDownloadedSource&&this.provider&&this.ecommerceData){let e=this.ecommerceData?.[this.provider];if(e?.products){this.products=e.products,this.productsState="loaded";return}}this.productsState="loading";let t=[];try{t=await this.adapter.loadProducts(this.numId,this.isPublished,this.isScreenshoter),this.productsState="loaded"}catch(e){console.error("Load ecommerce products",e),this.productsState="error"}this.products=t,this.triggerDataChanges({products:t})}getProductById(t){return this.products?.find(e=>e.id===t)}getProductSelectOptions(t){return this.adapter?this.adapter.mapProductsToSelectOptions(this.products,t):[]}isProductActive(t){let e=this.getProductById(t);if(e)return this.adapter?this.adapter.isProductActive(e):!1}getInvalidAddToCartWidgets(t){let e=t.filter(i=>i.type==="addtocart"&&!i.hidden);if(!e.length)return[];let r=this.products?this.products.map(i=>i.id):[];return e.filter(i=>!i.selected_product_id||!r.includes(i.selected_product_id))}productHasActiveOptions(t){return this.adapter?this.adapter.productHasActiveOptions(t):!1}isProductAvailable(t,e){return!!this.adapter?.isProductAvailable(t,e)}getProductForAddToCart(t,e){return this.adapter?this.adapter.getProductForAddToCart(t,e):null}initFrontendLibrary(){this.adapter&&this.adapter.initFrontendLibrary(this.ecommerceData)}getFormattedProductToAddToCart(t,e){return this.adapter?this.adapter.getFormattedProductToAddToCart(t,e):null}goToCheckout(t,e,r,i){if(this.adapter)if(this.adapter instanceof h)this.adapter.goToCheckout({items:t,callbacks:{onOpen:e,onPlaced:async()=>{await this.loadProducts(),typeof r=="function"&&r()},onClose:i}});else if(this.adapter instanceof d){let o={allow_promotion_codes:!1};this.cartWidgetData&&(o.allow_promotion_codes=!!this.cartWidgetData["stripe-allow_promotion_codes"],this.cartWidgetData["stripe-allowed_countries"]?.length&&(o.shipping_address_collection={allowed_countries:this.cartWidgetData["stripe-allowed_countries"].map(a=>a.value)}),this.cartWidgetData["stripe-shipping_rates"]?.length&&(o.shipping_options=this.cartWidgetData["stripe-shipping_rates"].map(a=>({shipping_rate:a})))),this.adapter.goToCheckout({items:t,options:o})}else this.adapter.goToCheckout({items:t,callbacks:{onOpen:e,onPlaced:r}})}}});var st,j=m(()=>{"use strict";T();st=async(p,t,e)=>S.get(`/api/viewer/project/${p}/widgets`,{pageId:t},{priority:"high",signal:e})});export{g as a,M as b,st as c,j as d};
